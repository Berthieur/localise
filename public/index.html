<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìç Suivi Multi-Ancres ESP32</title>
<style>
  /* Styles identiques √† ceux que tu avais */
  body { background: #111; color: #eee; font-family: Arial, sans-serif; padding: 20px; }
  .status-bar { display: flex; gap: 20px; margin-bottom: 20px; }
  .status { padding: 10px 20px; border-radius: 20px; font-weight: bold; }
  .connected { background: #28a745; }
  .disconnected { background: #dc3545; }
  canvas { border: 2px solid #444; display: block; margin: 0 auto 20px; background: #000; }
</style>
</head>
<body>
<h1>üìç Suivi Multi-Ancres ESP32</h1>
<div class="status-bar">
  <div id="status" class="status disconnected">D√©connect√©</div>
  <div id="badgeCount" class="status">0 Badge(s) d√©tect√©(s)</div>
</div>
<canvas id="map" width="800" height="600"></canvas>
<div id="anchorList"></div>
<div id="badgeList"></div>

<script>
const ws = new WebSocket(`ws://${location.hostname}:8080`);
const canvas = document.getElementById("map");
const ctx = canvas.getContext("2d");
const statusEl = document.getElementById("status");
const badgeCountEl = document.getElementById("badgeCount");
const anchorListEl = document.getElementById("anchorList");
const badgeListEl = document.getElementById("badgeList");

const SCALE = 130;
const OFFSET_X = 100;
const OFFSET_Y = 500;

const anchors = [
  { id: 1, x: 0, y: 0, name: "Ancre 1", color: "#ff6b6b" },
  { id: 2, x: 5, y: 0, name: "Ancre 2", color: "#4ecdc4" },
  { id: 3, x: 2.5, y: 4, name: "Ancre 3", color: "#95e1d3" }
];

ws.onopen = () => {
  statusEl.textContent = "Connect√©";
  statusEl.classList.remove("disconnected");
  statusEl.classList.add("connected");

  // Identification au serveur
  ws.send(JSON.stringify({ type: "web_client" }));

  updateAnchorList();
};

ws.onclose = () => {
  statusEl.textContent = "D√©connect√©";
  statusEl.classList.remove("connected");
  statusEl.classList.add("disconnected");
};

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  if(data.type === "positions") {
    drawScene(data.badges);
    updateBadgeList(data.badges);
    badgeCountEl.textContent = `${data.badges.length} Badge(s) d√©tect√©(s)`;
  }
};

function drawScene(badges) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  anchors.forEach(a => {
    const px = OFFSET_X + a.x*SCALE;
    const py = OFFSET_Y - a.y*SCALE;
    ctx.fillStyle = a.color;
    ctx.beginPath();
    ctx.arc(px, py, 15, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = "#fff";
    ctx.fillText(a.name, px, py+25);
  });

  badges.forEach(b => {
    const px = OFFSET_X + b.x*SCALE;
    const py = OFFSET_Y - b.y*SCALE;
    ctx.fillStyle = "#0f0";
    ctx.beginPath();
    ctx.arc(px, py, 10, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = "#0f0";
    ctx.fillText(b.ssid, px, py-15);
  });
}

function updateAnchorList() {
  anchorListEl.innerHTML = anchors.map(a =>
    `<div>${a.name} (${a.x}m, ${a.y}m)</div>`
  ).join('');
}

function updateBadgeList(badges) {
  if(!badges.length) {
    badgeListEl.innerHTML = 'Aucun badge d√©tect√©';
    return;
  }
  badgeListEl.innerHTML = badges.map(b =>
    `<div>${b.ssid}: (${b.x.toFixed(2)}, ${b.y.toFixed(2)})</div>`
  ).join('');
}

drawScene([]);
</script>
</body>
</html>
