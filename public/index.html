<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìç Suivi Multi-Ancres ESP32</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #eee;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      min-height: 100vh;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5em;
      text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
    }
    .status-bar {
      display: flex; justify-content: center; gap: 20px;
      margin-bottom: 30px; flex-wrap: wrap;
    }
    .status {
      padding: 12px 24px; border-radius: 25px; font-weight: bold;
      display: flex; align-items: center; gap: 10px;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    .status::before { content: '‚óè'; font-size: 1.5em; }
    .connected { background: linear-gradient(135deg, #28a745, #20c997); }
    .disconnected { background: linear-gradient(135deg, #dc3545, #e83e8c); }
    .canvas-container {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px; padding: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      margin-bottom: 30px;
    }
    canvas {
      background: #0f1419; border: 3px solid #2c3e50; border-radius: 15px;
      display: block; margin: 0 auto;
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.2);
    }
    .info-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px; margin-top: 30px;
    }
    .info-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px; padding: 20px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .info-card h3 { color: #00d9ff; margin-bottom: 15px; font-size: 1.3em; }
    .badge-item {
      background: rgba(0, 217, 255, 0.1);
      padding: 10px; margin: 8px 0; border-radius: 8px;
      border-left: 3px solid #00d9ff;
    }
    .badge-name { font-weight: bold; color: #00ff88; }
    .badge-coords { color: #aaa; font-size: 0.9em; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    .active-scan { animation: pulse 1.5s infinite; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìç Suivi Multi-Ancres ESP32</h1>
    
    <div class="status-bar">
      <div id="status" class="status disconnected">D√©connect√©</div>
      <div id="badgeCount" class="status" style="background: linear-gradient(135deg, #6a11cb, #2575fc);">
        0 Badge(s) d√©tect√©(s)
      </div>
    </div>

    <div class="canvas-container">
      <canvas id="map" width="800" height="600"></canvas>
    </div>

    <div class="info-panel">
      <div class="info-card">
        <h3>üéØ Ancres Actives</h3>
        <div id="anchorList"></div>
      </div>
      <div class="info-card">
        <h3>üì± Badges D√©tect√©s</h3>
        <div id="badgeList"></div>
      </div>
    </div>
  </div>

  <script>
    const ws = new WebSocket("ws://localhost:8080");
    const canvas = document.getElementById("map");
    const ctx = canvas.getContext("2d");
    const statusEl = document.getElementById("status");
    const badgeCountEl = document.getElementById("badgeCount");
    const anchorListEl = document.getElementById("anchorList");
    const badgeListEl = document.getElementById("badgeList");

    const SCALE = 130; // pixels par m√®tre
    const OFFSET_X = 100;
    const OFFSET_Y = 500;

    const anchors = [
      { id: 1, x: 0, y: 0, name: "Ancre 1", color: "#ff6b6b" },
      { id: 2, x: 5, y: 0, name: "Ancre 2", color: "#4ecdc4" },
      { id: 3, x: 2.5, y: 4, name: "Ancre 3", color: "#95e1d3" }
    ];

    ws.onopen = () => {
      statusEl.textContent = "Connect√©";
      statusEl.classList.remove("disconnected");
      statusEl.classList.add("connected");

      // ‚úÖ ligne ajout√©e pour identification au serveur
      ws.send(JSON.stringify({ type: "web_client" }));

      updateAnchorList();
    };

    ws.onclose = () => {
      statusEl.textContent = "D√©connect√©";
      statusEl.classList.remove("connected");
      statusEl.classList.add("disconnected");
    };

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === "positions") {
        drawScene(data.badges);
        updateBadgeList(data.badges);
        badgeCountEl.textContent = `${data.badges.length} Badge(s) d√©tect√©(s)`;
      }
    };

    function drawScene(badges) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawGrid();

      ctx.strokeStyle = "rgba(100, 100, 100, 0.3)";
      ctx.lineWidth = 2;
      ctx.setLineDash([5, 5]);
      for (let i = 0; i < anchors.length; i++) {
        for (let j = i + 1; j < anchors.length; j++) {
          const a1 = anchors[i];
          const a2 = anchors[j];
          ctx.beginPath();
          ctx.moveTo(OFFSET_X + a1.x * SCALE, OFFSET_Y - a1.y * SCALE);
          ctx.lineTo(OFFSET_X + a2.x * SCALE, OFFSET_Y - a2.y * SCALE);
          ctx.stroke();
        }
      }
      ctx.setLineDash([]);

      anchors.forEach(a => {
        const px = OFFSET_X + a.x * SCALE;
        const py = OFFSET_Y - a.y * SCALE;

        ctx.shadowBlur = 15;
        ctx.shadowColor = a.color;
        ctx.fillStyle = a.color + "40";
        ctx.beginPath();
        ctx.arc(px, py, 20, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = a.color;
        ctx.beginPath();
        ctx.arc(px, py, 12, 0, Math.PI * 2);
        ctx.fill();

        ctx.shadowBlur = 0;
        ctx.fillStyle = "#fff";
        ctx.font = "bold 14px Arial";
        ctx.textAlign = "center";
        ctx.fillText(a.name, px, py + 35);
      });

      badges.forEach(b => {
        const px = OFFSET_X + b.x * SCALE;
        const py = OFFSET_Y - b.y * SCALE;

        ctx.shadowBlur = 20;
        ctx.shadowColor = "#00ff88";
        ctx.fillStyle = "#00ff88";
        ctx.beginPath();
        ctx.arc(px, py, 10, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;

        ctx.fillStyle = "#00ff88";
        ctx.font = "bold 12px Arial";
        ctx.textAlign = "center";
        ctx.fillText(b.ssid, px, py - 15);

        ctx.fillStyle = "#aaa";
        ctx.font = "10px Arial";
        ctx.fillText(`(${b.x.toFixed(2)}, ${b.y.toFixed(2)})`, px, py + 25);
      });
    }

    function drawGrid() {
      ctx.strokeStyle = "rgba(255, 255, 255, 0.1)";
      ctx.lineWidth = 1;
      for (let x = 0; x <= 5; x++) {
        const px = OFFSET_X + x * SCALE;
        ctx.beginPath();
        ctx.moveTo(px, OFFSET_Y);
        ctx.lineTo(px, OFFSET_Y - 4 * SCALE);
        ctx.stroke();
        ctx.fillStyle = "#666";
        ctx.font = "10px Arial";
        ctx.textAlign = "center";
        ctx.fillText(x + "m", px, OFFSET_Y + 20);
      }
      for (let y = 0; y <= 4; y++) {
        const py = OFFSET_Y - y * SCALE;
        ctx.beginPath();
        ctx.moveTo(OFFSET_X, py);
        ctx.lineTo(OFFSET_X + 5 * SCALE, py);
        ctx.stroke();
        ctx.fillStyle = "#666";
        ctx.font = "10px Arial";
        ctx.textAlign = "right";
        ctx.fillText(y + "m", OFFSET_X - 10, py + 4);
      }
    }

    function updateAnchorList() {
      anchorListEl.innerHTML = anchors.map(a =>
        `<div class="badge-item">
          <div class="badge-name" style="color: ${a.color}">${a.name}</div>
          <div class="badge-coords">Position: (${a.x}m, ${a.y}m)</div>
        </div>`
      ).join('');
    }

    function updateBadgeList(badges) {
      if (badges.length === 0) {
        badgeListEl.innerHTML = '<div style="color: #666; font-style: italic;">Aucun badge d√©tect√©</div>';
        return;
      }
      badgeListEl.innerHTML = badges.map(b =>
        `<div class="badge-item active-scan">
          <div class="badge-name">${b.ssid}</div>
          <div class="badge-coords">Position: (${b.x.toFixed(2)}m, ${b.y.toFixed(2)}m)</div>
          <div class="badge-coords" style="font-size: 0.8em; margin-top: 5px;">
            Distances: A1=${b.distances[1]?.toFixed(2) || 'N/A'}m |
            A2=${b.distances[2]?.toFixed(2) || 'N/A'}m |
            A3=${b.distances[3]?.toFixed(2) || 'N/A'}m
          </div>
        </div>`
      ).join('');
    }

    drawScene([]);
  </script>
</body>
</html>
